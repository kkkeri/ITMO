<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Magic Cities</title>
    <link rel="stylesheet" href="css/styles.css">
    <script defer src="js/cities.js?v=2"></script>
</head>
<body>

<header>
    <h1>Города (MagicCity)</h1>
</header>

<div class="user-context">
    <label>
        Пользователь:
        <input id="userNameInput" value="student">
    </label>

    <label>
        Роль:
        <select id="userRoleSelect">
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
        </select>
    </label>

    <button onclick="applyUserContext()">Применить</button>
</div>

<main>
    <!-- фильтр по названию города -->
    <div class="filter-block">
        <label for="cityNameFilter">Название:</label>
        <input id="cityNameFilter" type="text" placeholder="часть названия города">

        <label for="cityGovernorFilter">Губернатор:</label>
        <input id="cityGovernorFilter" type="text" placeholder="часть типа существа (ELF, HUMAN...)">

        <button onclick="applyCityFilters()">Применить</button>
        <button onclick="resetCityFilter()">Сбросить</button>
    </div>

    <!-- кнопка создания нового города -->
    <div style="margin-top: 10px;">
        <button class="primary" onclick="startCreateCity()">Создать новый город</button>
    </div>

    <div class="filter-block" style="margin-top: 14px;">
        <label style="min-width: 0;">Импорт городов (JSON):</label>
        <input type="file" id="cityImportFile" accept=".json">
        <button class="primary" type="button" onclick="importCities()">Импорт</button>
    </div>
    <div id="cityImportMsg" class="error" style="display:none; margin-top: 8px;"></div>

    <!-- таблица городов -->
    <table>
        <thead>
        <tr>
            <th class="sortable" onclick="sortCitiesBy('id')">ID</th>
            <th class="sortable" onclick="sortCitiesBy('name')">Название</th>
            <th class="sortable" onclick="sortCitiesBy('area')">Площадь</th>
            <th class="sortable" onclick="sortCitiesBy('population')">Население</th>
            <th class="sortable" onclick="sortCitiesBy('establishmentDate')">Дата основания</th>
            <th class="sortable" onclick="sortCitiesBy('capital')">Столица</th>
            <th class="sortable" onclick="sortCitiesBy('governor')">Губернатор</th>
            <th class="sortable" onclick="sortCitiesBy('density')">Плотность</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="citiesTableBody">
        </tbody>
    </table>

    <!-- пагинация -->
    <div class="pagination">
        <button id="cityPrevPage">Назад</button>
        <span id="cityPageInfo">Страница 1 из 1</span>
        <button id="cityNextPage">Вперёд</button>

        <label style="margin-left: 15px;">
            Показать:
            <select id="cityPageSizeSelect">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
            </select>
            записей
        </label>
    </div>

    <section style="margin-top: 18px;">
        <h2>История импорта</h2>

        <button onclick="loadImportHistory()">Обновить</button>

        <table style="margin-top: 10px;">
            <thead>
            <tr>
                <th>ID</th>
                <th>Статус</th>
                <th>Пользователь</th>
                <th>Добавлено</th>
                <th>Ошибка</th>
            </tr>
            </thead>
            <tbody id="importHistoryBody"></tbody>
        </table>

        <div id="importHistoryError" class="error" style="display:none;"></div>
    </section>

    <!-- форма создания / редактирования города -->
    <!-- модальное окно создания / редактирования города -->
    <div id="cityEditSection" class="modal-overlay" style="display: none;">

        <div class="modal-window">
            <h2 id="cityEditTitle">Новый город</h2>

            <div class="form-row">
                <label for="cityName">Название:</label>
                <input id="cityName" type="text" maxlength="80">
            </div>

            <div class="form-row">
                <label for="cityArea">Площадь:</label>
                <input id="cityArea" type="number" min="1">
            </div>

            <div class="form-row">
                <label for="cityPopulation">Население:</label>
                <input id="cityPopulation" type="number" min="1">
            </div>

            <div class="form-row">
                <label for="cityEstablishmentDate">Дата основания:</label>
                <input id="cityEstablishmentDate" type="datetime-local">
            </div>

            <div class="form-row">
                <label for="cityCapital">Столица:</label>
                <input id="cityCapital" type="checkbox">
            </div>

            <div class="form-row">
                <label for="cityDensity">Плотность населения:</label>
                <input id="cityDensity" type="number" step="0.01" min="0.01">
            </div>

            <div class="form-row">
                <label for="cityGovernor">Губернатор (тип существа):</label>
                <input id="cityGovernor" type="text" placeholder="ELF / HUMAN / ...">
            </div>

            <div style="margin-top: 12px; text-align: right;">
                <button class="primary" onclick="saveCity()">Сохранить</button>
                <button onclick="cancelCityEdit()">Отмена</button>
            </div>

            <div id="cityFormError" class="error" style="display: none;"></div>
        </div>

    </div>

    <!-- блок удаления с перепривязкой существ -->
    <section id="cityDeleteSection" style="margin-top: 20px; display: none;">
        <h2>Удаление города с перепривязкой существ</h2>

        <div class="form-row">
            <label>Удаляемый город (ID):</label>
            <span id="deleteCityIdLabel"></span>
        </div>

        <div class="form-row">
            <label for="reassignCityId">Перепривязать существ к городу:</label>
            <select id="reassignCityId">
                <option value="">(оставить без города)</option>
            </select>
        </div>

        <div style="margin-top: 10px;">
            <button class="danger" onclick="confirmDeleteCity()">Удалить</button>
            <button onclick="cancelDeleteCity()">Отмена</button>
        </div>

        <div id="cityDeleteError" class="error" style="display: none;"></div>
    </section>

    <div id="cityGlobalError" class="error" style="display: none;"></div>
</main>

</body>
</html>